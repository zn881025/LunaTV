name: Smart Auto Sync

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync_from_upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync and Check
        run: |
          # 1. é…ç½®èº«ä»½
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          # 2. æ·»åŠ å¹¶æ‹‰å–åŸä½œè€…ä»£ç 
          git remote add upstream https://github.com/SzeMeng76/LunaTV.git
          git fetch upstream main

          # 3. æ£€æµ‹æ˜¯å¦æœ‰æ›´æ–°
          LOCAL_HASH=$(git rev-parse HEAD)
          UPSTREAM_HASH=$(git rev-parse upstream/main)

          if [ "$LOCAL_HASH" = "$UPSTREAM_HASH" ]; then
            echo "âœ… å·²ç»æ˜¯æœ€æ–°çŠ¶æ€ï¼Œæ— éœ€åŒæ­¥ã€‚"
            exit 0
          fi

          echo "ğŸš€ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ›´æ–°ï¼Œå‡†å¤‡åŒæ­¥..."

          # 4. å¤‡ä»½ä½ çš„ Actions é…ç½®æ–‡ä»¶
          mkdir -p ../temp_backup
          cp -r .github/* ../temp_backup/

          # 5. å¼ºåˆ¶é‡ç½®
          git checkout main
          git reset --hard upstream/main

          # 6. è¿˜åŸ Actions é…ç½®æ–‡ä»¶
          mkdir -p .github
          cp -r ../temp_backup/* .github/

          # 7. æäº¤å¹¶å¼ºåˆ¶æ¨é€
          git add .github/
          if ! git diff-index --quiet HEAD; then
            git commit -m "Auto Sync: Update to latest upstream and keep workflow"
          fi
          git push origin main --force
          echo "âœ¨ åŒæ­¥å®Œæˆï¼"
